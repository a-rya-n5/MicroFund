<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loans ‚Äî MicroFund</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="page-bg"></div>
<div class="app-layout">
  <div id="sidebarContainer"></div>
  <div class="main-content">
    <div id="topbarContainer"></div>
    <div class="page-content">
      <div class="page-header flex-between mb-24">
        <div>
          <h1 class="page-title" id="pageTitle">Loans</h1>
          <div class="page-subtitle" id="pageSubtitle">Manage your loan activity</div>
        </div>
        <div id="pageActions"></div>
      </div>
      <div class="tab-group" id="loanTabs" style="max-width:520px;margin-bottom:20px"></div>
      <div class="filter-bar mb-24" id="filterBar" style="display:none"></div>
      <div id="loansContent"><div class="loading-state"><div class="spinner"></div></div></div>
    </div>
  </div>
</div>

<!-- Apply Loan Modal -->
<div class="modal-overlay" id="applyModal">
  <div class="modal modal-md">
    <div class="modal-header">
      <div><div class="modal-title">Apply for a Loan</div><div style="font-size:13px;color:var(--text-muted);margin-top:4px">Fill in the details. Admin reviews within 24 hours.</div></div>
      <button class="modal-close" onclick="Modal.close('applyModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Loan Amount (‚Çπ)</label>
          <input type="number" id="loanAmount" class="form-input" placeholder="e.g. 25000" min="1000" max="500000" oninput="updateApplyEMI()">
        </div>
        <div class="form-group">
          <label class="form-label">Interest Rate (% p.a.)</label>
          <input type="number" id="loanRate" class="form-input" placeholder="e.g. 12" min="1" max="50" step="0.5" value="12" oninput="updateApplyEMI()">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Tenure: <span id="tenureDisplay" style="color:var(--gold)">12 months</span></label>
        <input type="range" id="loanTenure" min="1" max="60" value="12" style="width:100%;accent-color:var(--gold)" oninput="document.getElementById('tenureDisplay').textContent=this.value+' months';updateApplyEMI()">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted)"><span>1 mo</span><span>60 mo</span></div>
      </div>
      <div class="form-group">
        <label class="form-label">Loan Purpose</label>
        <select id="loanPurpose" class="form-input form-select">
          <option value="">Select purpose...</option>
          <option>Business Expansion</option><option>Medical Expenses</option>
          <option>Education</option><option>Home Renovation</option>
          <option>Agriculture</option><option>Debt Consolidation</option>
          <option>Vehicle Purchase</option><option>Emergency Fund</option><option>Other</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Description (Optional)</label>
        <textarea id="loanDesc" class="form-input" rows="3" placeholder="Describe how you'll use the loan..."></textarea>
      </div>
      <div id="applyEMIPreview" style="display:none;background:rgba(212,168,83,0.08);border:1px solid rgba(212,168,83,0.2);border-radius:12px;padding:16px;margin-bottom:16px">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:10px">Loan Preview</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;text-align:center">
          <div><div style="font-size:11px;color:var(--text-muted)">Monthly EMI</div><div class="mono" id="previewEMI" style="font-size:18px;font-weight:700;color:var(--gold)">‚Äî</div></div>
          <div><div style="font-size:11px;color:var(--text-muted)">Total Payable</div><div class="mono" id="previewTotal" style="font-size:18px;font-weight:700;color:var(--text-primary)">‚Äî</div></div>
          <div><div style="font-size:11px;color:var(--text-muted)">Total Interest</div><div class="mono" id="previewInterest" style="font-size:18px;font-weight:700;color:var(--danger)">‚Äî</div></div>
        </div>
      </div>
      <div id="applyError" style="color:var(--danger);font-size:13px;margin-bottom:12px;display:none"></div>
      <button class="btn btn-primary w-full btn-lg" onclick="submitLoanApplication()" id="applyBtn">Submit Application ‚Üí</button>
    </div>
  </div>
</div>

<!-- Loan Detail Modal -->
<div class="modal-overlay" id="loanDetailModal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title" id="detailTitle">Loan Details</div>
      <button class="modal-close" onclick="Modal.close('loanDetailModal')">‚úï</button>
    </div>
    <div class="modal-body" id="loanDetailBody"></div>
  </div>
</div>

<div id="emiModalContainer"></div>
<div class="toast-container"></div>
<script src="/js/common.js"></script>
<script src="/js/layout.js"></script>
<script>
let currentUser = null, currentTab = 'list', currentFilter = 'all', currentLoans = [];

document.addEventListener('DOMContentLoaded', async () => {
  currentUser = initPage('loans');
  if (!currentUser) return;
  document.getElementById('sidebarContainer').innerHTML = getSidebarHTML();
  document.getElementById('topbarContainer').innerHTML = getTopbarHTML('Loans');
  document.getElementById('emiModalContainer').innerHTML = getEMIModalHTML();
  initPageControls('loans');
  Modal.closeOnOverlay('applyModal');
  Modal.closeOnOverlay('loanDetailModal');
  Modal.closeOnOverlay('emiCalcModal');

  const params = new URLSearchParams(window.location.search);
  if (params.get('tab') === 'apply' && currentUser.role === 'borrower') setTimeout(() => Modal.open('applyModal'), 400);

  buildTabs();
  await loadLoans();
  refreshWalletDisplay();
});

function buildTabs() {
  const tabsEl = document.getElementById('loanTabs');
  const actionsEl = document.getElementById('pageActions');
  const titleEl = document.getElementById('pageTitle');
  const subtitleEl = document.getElementById('pageSubtitle');

  if (currentUser.role === 'borrower') {
    titleEl.textContent = 'My Loans';
    subtitleEl.textContent = 'Track and manage your loan applications and repayments';
    actionsEl.innerHTML = '<button class="btn btn-primary" onclick="Modal.open(\'applyModal\')">‚ûï Apply for Loan</button>';
    tabsEl.innerHTML = `
      <button class="tab-btn active" onclick="setTab('list',this)">All Loans</button>
      <button class="tab-btn" onclick="setTab('active',this)">Active</button>
      <button class="tab-btn" onclick="setTab('completed',this)">Completed</button>
    `;
  } else if (currentUser.role === 'lender') {
    titleEl.textContent = 'Browse Loans';
    subtitleEl.textContent = 'Fund approved loan requests and track your portfolio';
    tabsEl.innerHTML = `
      <button class="tab-btn active" onclick="setTab('available',this)">Available to Fund</button>
      <button class="tab-btn" onclick="setTab('funded',this)">My Portfolio</button>
    `;
    document.getElementById('filterBar').style.display = 'flex';
    document.getElementById('filterBar').innerHTML = `
      <button class="filter-chip active" onclick="setFilter('all',this)">All Risk</button>
      <button class="filter-chip" onclick="setFilter('low',this)">üü¢ Low Risk</button>
      <button class="filter-chip" onclick="setFilter('medium',this)">üü° Medium Risk</button>
      <button class="filter-chip" onclick="setFilter('high',this)">üî¥ High Risk</button>
    `;
    const params = new URLSearchParams(window.location.search);
    if (params.get('tab') === 'funded') { currentTab = 'funded'; document.querySelectorAll('#loanTabs .tab-btn')[0].classList.remove('active'); document.querySelectorAll('#loanTabs .tab-btn')[1].classList.add('active'); }
  }
}

function setTab(tab, btn) {
  currentTab = tab;
  document.querySelectorAll('#loanTabs .tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  loadLoans();
}

function setFilter(filter, btn) {
  currentFilter = filter;
  document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderLoans();
}

async function loadLoans() {
  document.getElementById('loansContent').innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  let endpoint = '/loans';
  if (currentUser.role === 'borrower') {
    const map = {list:'', active:'active', completed:'completed'};
    const s = map[currentTab];
    endpoint = s ? '/loans?status='+s : '/loans';
  } else if (currentUser.role === 'lender') {
    endpoint = currentTab === 'available' ? '/loans?status=approved' : '/loans?status=funded,active,completed';
  }
  const res = await api.get(endpoint);
  if (!res.ok) { document.getElementById('loansContent').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-title">Failed to load</div></div>'; return; }
  currentLoans = res.data.loans || [];
  renderLoans();
}

function renderLoans() {
  const container = document.getElementById('loansContent');
  let loans = currentLoans;
  if (currentUser.role === 'lender' && currentFilter !== 'all') loans = loans.filter(l => l.riskScore === currentFilter);

  if (loans.length === 0) {
    container.innerHTML = `<div class="card"><div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-title">No loans found</div>${currentUser.role==='borrower'?'<button class="btn btn-primary btn-sm" style="margin-top:16px" onclick="Modal.open(\'applyModal\')">Apply for Loan</button>':''}</div></div>`;
    return;
  }

  if (currentUser.role === 'lender' && currentTab === 'available') renderLenderCards(loans, container);
  else if (currentUser.role === 'borrower') renderBorrowerTable(loans, container);
  else renderLenderPortfolio(loans, container);
}

function renderBorrowerTable(loans, container) {
  container.innerHTML = `
    <div class="card"><div class="card-body" style="padding:0"><div class="table-wrapper"><table>
      <thead><tr><th>Purpose</th><th>Amount</th><th>EMI</th><th>Tenure</th><th>Status</th><th>Progress</th><th>Applied</th><th>Action</th></tr></thead>
      <tbody>
        ${loans.map(loan => `<tr>
          <td><strong>${loan.purpose}</strong>${loan.description?`<br><span style="font-size:11px;color:var(--text-muted)">${loan.description.slice(0,40)}</span>`:''}</td>
          <td class="mono">${Format.currency(loan.amount)}</td>
          <td class="mono">${Format.currency(loan.emi)}/mo</td>
          <td>${loan.tenure}mo @ ${loan.interestRate}%</td>
          <td>${Badge.status(loan.status)}</td>
          <td style="min-width:120px">${loan.status==='active'&&loan.totalPayable?`<div class="progress-bar" style="margin-bottom:2px"><div class="progress-fill" style="width:${Math.round((loan.paidAmount/loan.totalPayable)*100)}%"></div></div><span style="font-size:10px;color:var(--text-muted)">${Math.round((loan.paidAmount/loan.totalPayable)*100)}%</span>`:'‚Äî'}</td>
          <td style="font-size:12px">${Format.date(loan.createdAt)}</td>
          <td>${loan.status==='active'?`<button class="btn btn-success btn-sm" onclick="viewLoanDetail('${loan._id}')">üí≥ Pay EMI</button>`:`<button class="btn btn-ghost btn-sm" onclick="viewLoanDetail('${loan._id}')">View</button>`}</td>
        </tr>`).join('')}
      </tbody>
    </table></div></div></div>
  `;
}

function renderLenderCards(loans, container) {
  container.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px">
    ${loans.map(loan => `
      <div class="loan-card" onclick="viewLoanDetail('${loan._id}')">
        <div class="loan-card-header">
          <div><div class="loan-card-amount">${Format.currency(loan.amount)}</div><div class="loan-card-emi">${Format.currency(loan.emi)}/month ¬∑ ${loan.tenure} months</div></div>
          ${Badge.risk(loan.riskScore)}
        </div>
        <div style="margin-bottom:12px"><div style="font-size:14px;font-weight:600;color:var(--text-primary)">${loan.purpose}</div><div style="font-size:12px;color:var(--text-muted);margin-top:2px">by ${loan.borrower?.name||'Borrower'}</div></div>
        <div class="loan-card-stats">
          <div class="loan-stat"><div class="loan-stat-val" style="color:var(--gold)">${loan.interestRate}%</div><div class="loan-stat-lbl">Rate p.a.</div></div>
          <div class="loan-stat"><div class="loan-stat-val">${Format.currency(loan.totalPayable)}</div><div class="loan-stat-lbl">You Receive</div></div>
          <div class="loan-stat"><div class="loan-stat-val" style="color:${Format.creditRating(loan.borrower?.creditScore||650).color}">${loan.borrower?.creditScore||650}</div><div class="loan-stat-lbl">Credit</div></div>
        </div>
        <button class="btn btn-primary w-full" onclick="event.stopPropagation();fundLoan('${loan._id}',${loan.amount})">Fund This Loan</button>
      </div>
    `).join('')}
  </div>`;
}

function renderLenderPortfolio(loans, container) {
  container.innerHTML = `
    <div class="card"><div class="card-body" style="padding:0"><div class="table-wrapper"><table>
      <thead><tr><th>Borrower</th><th>Purpose</th><th>Funded</th><th>Returns</th><th>Status</th><th>Repaid</th><th>Action</th></tr></thead>
      <tbody>
        ${loans.map(loan => `<tr>
          <td><strong>${loan.borrower?.name||'‚Äî'}</strong><br><span style="font-size:11px;color:var(--text-muted)">${loan.borrower?.email||''}</span></td>
          <td>${loan.purpose}</td>
          <td class="mono">${Format.currency(loan.amount)}</td>
          <td class="mono" style="color:var(--success)">${Format.currency(loan.totalPayable)}</td>
          <td>${Badge.status(loan.status)}</td>
          <td style="min-width:140px">${(loan.status==='active'||loan.status==='completed')&&loan.totalPayable?`<div class="progress-bar" style="margin-bottom:2px"><div class="progress-fill" style="width:${Math.round((loan.paidAmount/loan.totalPayable)*100)}%"></div></div><span style="font-size:10px;color:var(--text-muted)">${Format.currency(loan.paidAmount)}</span>`:'‚Äî'}</td>
          <td><button class="btn btn-ghost btn-sm" onclick="viewLoanDetail('${loan._id}')">View</button></td>
        </tr>`).join('')}
      </tbody>
    </table></div></div></div>
  `;
}

async function fundLoan(loanId, amount) {
  const r = await api.get('/users/wallet');
  if ((r.data?.wallet||0) < amount) { Toast.error('Insufficient balance', 'Need ' + Format.currency(amount)); return; }
  if (!confirm('Fund this loan for ' + Format.currency(amount) + '?\n\nThis deducts from your wallet.')) return;
  const res = await api.post('/loans/'+loanId+'/fund');
  if (res.ok) { Toast.success('Loan funded! üéâ', 'EMI payments will credit to your wallet'); await loadLoans(); refreshWalletDisplay(); }
  else Toast.error('Failed to fund', res.data.message);
}

async function viewLoanDetail(loanId) {
  Modal.open('loanDetailModal');
  document.getElementById('loanDetailBody').innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  const [res, schedRes] = await Promise.all([api.get('/loans/'+loanId), api.get('/loans/'+loanId+'/schedule')]);
  if (!res.ok) { document.getElementById('loanDetailBody').innerHTML = '<div class="empty-state"><div class="empty-state-title">Failed to load</div></div>'; return; }

  const loan = res.data.loan;
  const schedule = schedRes.data?.schedule || [];
  const nextEMI = schedule.find(e => e.status === 'pending');
  const paidCount = schedule.filter(e => e.status === 'paid').length;

  document.getElementById('detailTitle').textContent = 'Loan: ' + loan.purpose;
  document.getElementById('loanDetailBody').innerHTML = `
    <div class="grid-2" style="margin-bottom:20px">
      <div>
        <div class="info-row"><span class="info-label">Amount</span><span class="info-value">${Format.currency(loan.amount)}</span></div>
        <div class="info-row"><span class="info-label">Interest Rate</span><span class="info-value">${loan.interestRate}% p.a.</span></div>
        <div class="info-row"><span class="info-label">Tenure</span><span class="info-value">${loan.tenure} months</span></div>
        <div class="info-row"><span class="info-label">Monthly EMI</span><span class="info-value" style="color:var(--gold)">${Format.currency(loan.emi)}</span></div>
        <div class="info-row"><span class="info-label">Total Payable</span><span class="info-value">${Format.currency(loan.totalPayable)}</span></div>
        <div class="info-row"><span class="info-label">Total Interest</span><span class="info-value" style="color:var(--danger)">${Format.currency(loan.totalInterest)}</span></div>
      </div>
      <div>
        <div class="info-row"><span class="info-label">Status</span><span class="info-value">${Badge.status(loan.status)}</span></div>
        <div class="info-row"><span class="info-label">Risk</span><span class="info-value">${Badge.risk(loan.riskScore)}</span></div>
        <div class="info-row"><span class="info-label">Applied</span><span class="info-value">${Format.date(loan.createdAt)}</span></div>
        ${loan.fundedAt?`<div class="info-row"><span class="info-label">Funded</span><span class="info-value">${Format.date(loan.fundedAt)}</span></div>`:''}
        <div class="info-row"><span class="info-label">Repaid</span><span class="info-value" style="color:var(--success)">${Format.currency(loan.paidAmount)}</span></div>
        <div class="info-row"><span class="info-label">Remaining</span><span class="info-value">${Format.currency(loan.remainingAmount)}</span></div>
      </div>
    </div>

    ${loan.status==='active'&&loan.totalPayable?`
      <div style="margin-bottom:20px">
        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-muted);margin-bottom:6px">
          <span>${paidCount} of ${loan.tenure} EMIs paid</span><span>${Math.round((loan.paidAmount/loan.totalPayable)*100)}%</span>
        </div>
        <div class="progress-bar" style="height:10px"><div class="progress-fill" style="width:${Math.round((loan.paidAmount/loan.totalPayable)*100)}%"></div></div>
      </div>
      ${currentUser.role==='borrower'&&nextEMI?`
        <div style="background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);border-radius:12px;padding:16px;margin-bottom:20px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-size:12px;color:var(--text-muted)">Next EMI Due</div><div class="mono" style="font-size:22px;font-weight:700;color:var(--gold)">${Format.currency(nextEMI.amount)}</div><div style="font-size:12px;color:var(--text-muted)">Due: ${Format.date(nextEMI.dueDate)} ¬∑ EMI #${nextEMI.installmentNo}</div></div>
            <button class="btn btn-success btn-lg" onclick="payNextEMI('${loan._id}',${nextEMI.amount})">Pay Now</button>
          </div>
        </div>
      `:''}
    `:''}

    ${loan.status==='approved'&&currentUser.role==='lender'?`<button class="btn btn-primary w-full btn-lg" onclick="Modal.close('loanDetailModal');fundLoan('${loan._id}',${loan.amount})" style="margin-bottom:20px">üí∞ Fund ‚Äî ${Format.currency(loan.amount)}</button>`:''}

    ${schedule.length>0?`
      <div>
        <div style="font-size:13px;font-weight:700;color:var(--text-primary);margin-bottom:12px">EMI Schedule</div>
        <div style="max-height:300px;overflow-y:auto">
          ${schedule.map(e=>`
            <div class="emi-item">
              <div class="emi-num ${e.status==='pending'&&nextEMI&&e.installmentNo===nextEMI.installmentNo?'next':e.status}">${e.status==='paid'?'‚úì':e.installmentNo}</div>
              <div class="emi-details">
                <div style="display:flex;justify-content:space-between"><div class="emi-amount">${Format.currency(e.amount)}</div><span class="badge badge-${e.status}">${e.status}${e.paidAt?' ¬∑ '+Format.date(e.paidAt):''}</span></div>
                <div class="emi-date">Due: ${Format.date(e.dueDate)}</div>
                <div class="emi-breakdown">P: ${Format.currency(e.principal)} ¬∑ I: ${Format.currency(e.interest)} ¬∑ Bal: ${Format.currency(e.balance)}</div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `:''}

    ${loan.adminNote?`<div style="margin-top:16px;padding:12px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:10px"><div style="font-size:11px;font-weight:700;color:var(--warning);margin-bottom:4px">ADMIN NOTE</div><div style="font-size:13px;color:var(--text-secondary)">${loan.adminNote}</div></div>`:''}
  `;
}

async function payNextEMI(loanId, amount) {
  const r = await api.get('/users/wallet');
  if ((r.data?.wallet||0) < amount) { Toast.error('Insufficient balance', 'Need ' + Format.currency(amount) + '. Top up your wallet.'); return; }
  if (!confirm('Pay EMI of ' + Format.currency(amount) + '?')) return;
  const res = await api.post('/loans/'+loanId+'/repay');
  if (res.ok) {
    Toast.success(res.data.message, 'Balance: ' + Format.currency(res.data.newBalance) + ' ¬∑ Credit: ' + res.data.newCreditScore);
    Modal.close('loanDetailModal');
    await loadLoans();
    refreshWalletDisplay();
  } else Toast.error('Payment failed', res.data.message);
}

function updateApplyEMI() {
  const P = parseFloat(document.getElementById('loanAmount').value);
  const r = parseFloat(document.getElementById('loanRate').value);
  const n = parseInt(document.getElementById('loanTenure').value);
  if (P && r && n) {
    const result = EMI.calculate(P,r,n);
    if (result) {
      document.getElementById('applyEMIPreview').style.display = 'block';
      document.getElementById('previewEMI').textContent = Format.currency(result.emi,2);
      document.getElementById('previewTotal').textContent = Format.currency(result.totalPayable,2);
      document.getElementById('previewInterest').textContent = Format.currency(result.totalInterest,2);
    }
  } else document.getElementById('applyEMIPreview').style.display = 'none';
}

async function submitLoanApplication() {
  const amount = document.getElementById('loanAmount').value;
  const interestRate = document.getElementById('loanRate').value;
  const tenure = document.getElementById('loanTenure').value;
  const purpose = document.getElementById('loanPurpose').value;
  const description = document.getElementById('loanDesc').value;
  const errorEl = document.getElementById('applyError');
  const btn = document.getElementById('applyBtn');
  errorEl.style.display = 'none';
  if (!amount||!interestRate||!tenure||!purpose) { errorEl.textContent='Please fill all required fields'; errorEl.style.display='block'; return; }
  if (parseFloat(amount)<1000) { errorEl.textContent='Minimum amount is ‚Çπ1,000'; errorEl.style.display='block'; return; }
  btn.textContent = 'Submitting...'; btn.disabled = true;
  const res = await api.post('/loans', {amount:parseFloat(amount),interestRate:parseFloat(interestRate),tenure:parseInt(tenure),purpose,description});
  if (res.ok) {
    Toast.success('Application submitted!', 'Admin will review within 24 hours');
    Modal.close('applyModal');
    await loadLoans();
    ['loanAmount','loanDesc'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('loanPurpose').value = '';
    document.getElementById('applyEMIPreview').style.display = 'none';
  } else { errorEl.textContent = res.data.message||'Application failed'; errorEl.style.display='block'; }
  btn.textContent = 'Submit Application ‚Üí'; btn.disabled = false;
}
</script>
</body>
</html>
