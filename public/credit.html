<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Credit Score ‚Äî MicroFund</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="page-bg"></div>
<div class="app-layout">
  <div id="sidebarContainer"></div>
  <div class="main-content">
    <div id="topbarContainer"></div>
    <div class="page-content">
      <div class="page-header"><h1 class="page-title">Credit Score</h1><div class="page-subtitle">Your creditworthiness and score history</div></div>

      <div class="grid-2 mb-24">
        <div class="card">
          <div class="card-header"><div class="card-title">Your Credit Score</div></div>
          <div class="card-body"><div id="scoreGauge" style="text-align:center;padding:20px 0"><div class="loading-state"><div class="spinner"></div></div></div></div>
        </div>
        <div class="card">
          <div class="card-header"><div><div class="card-title">Score Simulator</div><div class="card-subtitle">See how actions affect your score</div></div></div>
          <div class="card-body">
            <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Demo tool ‚Äî simulate credit score impacts of different actions.</p>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn btn-ghost" onclick="simulate('on_time_payment')" style="justify-content:space-between"><span>‚úÖ On-time EMI Payment</span><span style="color:var(--success);font-family:'DM Mono',monospace">+5</span></button>
              <button class="btn btn-ghost" onclick="simulate('late_payment')" style="justify-content:space-between"><span>‚ö†Ô∏è Late Payment</span><span style="color:var(--warning);font-family:'DM Mono',monospace">-15</span></button>
              <button class="btn btn-ghost" onclick="simulate('missed_payment')" style="justify-content:space-between"><span>‚ùå Missed Payment</span><span style="color:var(--danger);font-family:'DM Mono',monospace">-30</span></button>
              <button class="btn btn-ghost" onclick="simulate('new_loan')" style="justify-content:space-between"><span>üîç New Loan Application</span><span style="color:var(--warning);font-family:'DM Mono',monospace">-10</span></button>
              <button class="btn btn-ghost" onclick="simulate('loan_closed')" style="justify-content:space-between"><span>üéâ Loan Fully Repaid</span><span style="color:var(--success);font-family:'DM Mono',monospace">+20</span></button>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-24">
        <div class="card-header"><div><div class="card-title">Score History</div><div class="card-subtitle">Changes over time</div></div></div>
        <div class="card-body"><div id="scoreHistory"><div class="loading-state"><div class="spinner"></div></div></div></div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">How to Improve Your Score</div></div>
        <div class="card-body">
          <div class="grid-2" style="gap:16px">
            <div style="padding:16px;background:rgba(34,197,94,0.05);border:1px solid rgba(34,197,94,0.2);border-radius:12px">
              <div style="font-size:16px;margin-bottom:8px">‚úÖ</div>
              <div style="font-size:13px;font-weight:600;color:var(--success);margin-bottom:6px">Good Habits</div>
              <ul style="font-size:12px;color:var(--text-muted);list-style:none;display:flex;flex-direction:column;gap:4px">
                <li>‚Ä¢ Pay EMIs on or before due date</li>
                <li>‚Ä¢ Complete loan repayments fully</li>
                <li>‚Ä¢ Keep active loans manageable</li>
                <li>‚Ä¢ Maintain consistent repayment history</li>
              </ul>
            </div>
            <div style="padding:16px;background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.2);border-radius:12px">
              <div style="font-size:16px;margin-bottom:8px">‚ùå</div>
              <div style="font-size:13px;font-weight:600;color:var(--danger);margin-bottom:6px">Avoid These</div>
              <ul style="font-size:12px;color:var(--text-muted);list-style:none;display:flex;flex-direction:column;gap:4px">
                <li>‚Ä¢ Missing EMI payments</li>
                <li>‚Ä¢ Paying consistently late</li>
                <li>‚Ä¢ Defaulting on loans</li>
                <li>‚Ä¢ Too many simultaneous loans</li>
              </ul>
            </div>
          </div>
          <div style="margin-top:20px;height:12px;border-radius:100px;background:linear-gradient(90deg,#EF4444 0%,#FB923C 25%,#F59E0B 50%,#4ADE80 75%,#22C55E 100%)"></div>
          <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:4px;color:var(--text-muted)"><span>Poor (300)</span><span>Fair (580)</span><span>Good (670)</span><span>V.Good (740)</span><span>Exceptional (850)</span></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="emiModalContainer"></div>
<div class="toast-container"></div>
<script src="/js/common.js"></script>
<script src="/js/layout.js"></script>
<script>
let currentUser = null;
document.addEventListener('DOMContentLoaded', async () => {
  currentUser = initPage('credit');
  if (!currentUser) return;
  if (currentUser.role !== 'borrower') { window.location.href = '/dashboard.html'; return; }
  document.getElementById('sidebarContainer').innerHTML = getSidebarHTML();
  document.getElementById('topbarContainer').innerHTML = getTopbarHTML('Credit Score');
  document.getElementById('emiModalContainer').innerHTML = getEMIModalHTML();
  initPageControls('credit');
  Modal.closeOnOverlay('emiCalcModal');
  await loadCreditData();
});

async function loadCreditData() {
  const res = await api.get('/users/credit-score');
  if (!res.ok) return;
  const {creditScore, history} = res.data;
  const rating = Format.creditRating(creditScore);
  const circumference = 2*Math.PI*60;
  const filled = ((creditScore-300)/550)*circumference;

  document.getElementById('scoreGauge').innerHTML = `
    <div style="position:relative;display:inline-flex;align-items:center;justify-content:center">
      <svg width="180" height="180" viewBox="0 0 180 180" style="transform:rotate(-90deg)">
        <circle cx="90" cy="90" r="60" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="14"/>
        <circle cx="90" cy="90" r="60" fill="none" stroke="${rating.color}" stroke-width="14" stroke-dasharray="${filled} ${circumference}" stroke-linecap="round" style="transition:stroke-dasharray 1s ease"/>
      </svg>
      <div style="position:absolute;text-align:center">
        <div style="font-family:'Fraunces',serif;font-size:38px;font-weight:900;color:${rating.color}">${creditScore}</div>
        <div style="font-size:11px;color:var(--text-muted);letter-spacing:1px">out of 850</div>
        <div style="font-size:14px;font-weight:700;color:${rating.color};margin-top:4px">${rating.label}</div>
      </div>
    </div>
    <div style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;text-align:center">
      <div style="padding:10px;background:rgba(255,255,255,0.03);border-radius:8px"><div style="font-size:11px;color:var(--text-muted)">Min</div><div style="font-size:16px;font-weight:700;color:var(--danger)">300</div></div>
      <div style="padding:10px;background:rgba(212,168,83,0.08);border:1px solid rgba(212,168,83,0.2);border-radius:8px"><div style="font-size:11px;color:var(--text-muted)">Your Score</div><div style="font-size:16px;font-weight:700;color:${rating.color}">${creditScore}</div></div>
      <div style="padding:10px;background:rgba(255,255,255,0.03);border-radius:8px"><div style="font-size:11px;color:var(--text-muted)">Max</div><div style="font-size:16px;font-weight:700;color:var(--success)">850</div></div>
    </div>
  `;

  if (!history||!history.length) {
    document.getElementById('scoreHistory').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìà</div><div class="empty-state-title">No history yet</div><div class="empty-state-text">Score changes appear after loan activities</div></div>';
  } else {
    document.getElementById('scoreHistory').innerHTML = `<div style="max-height:400px;overflow-y:auto">
      ${history.slice().reverse().map(h=>`
        <div style="display:flex;align-items:center;gap:16px;padding:12px 0;border-bottom:1px solid var(--border)">
          <div style="width:40px;height:40px;border-radius:50%;background:${h.delta>=0?'rgba(34,197,94,0.1)':'rgba(239,68,68,0.1)'};display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">${h.delta>=0?'üìà':'üìâ'}</div>
          <div style="flex:1"><div style="font-size:13px;font-weight:600;color:var(--text-primary)">${h.reason}</div><div style="font-size:11px;color:var(--text-muted)">${Format.date(h.date,'datetime')}</div></div>
          <div style="text-align:right"><div style="font-family:'DM Mono',monospace;font-size:15px;font-weight:700;color:${h.delta>=0?'var(--success)':'var(--danger)'}">${h.delta>=0?'+':''}${h.delta}</div><div style="font-size:12px;color:var(--text-muted)">‚Üí ${h.score}</div></div>
        </div>
      `).join('')}
    </div>`;
  }
}

async function simulate(action) {
  const res = await api.post('/users/credit-simulate', {action});
  if (res.ok) { Toast.success('Score updated!', res.data.reason + ' ‚Üí ' + res.data.creditScore); await loadCreditData(); refreshWalletDisplay(); }
  else Toast.error('Failed', res.data.message);
}
</script>
</body>
</html>
